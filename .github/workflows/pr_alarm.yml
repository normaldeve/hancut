name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Send PR Alert to Discord
        uses: actions/github-script@v7
        with:
          script: |
            const webhook_url = "${{ secrets.DISCORD_PR_WEBHOOK}}";
            
            const pr = context.payload.pull_request;
            const action = context.payload.action;
            const actor = context.payload.sender.login;
            
            // ì•¡ì…˜ë³„ ì„¤ì •
            let color, actionText, emoji;
            if (action === 'opened') {
              color = 3066993; // ì´ˆë¡ìƒ‰
              actionText = 'ìƒˆ PR ìƒì„±';
              emoji = 'ğŸ”€';
            } else if (action === 'closed' && pr.merged) {
              color = 6817668; // ë³´ë¼ìƒ‰
              actionText = 'PR ë¨¸ì§€ ì™„ë£Œ';
              emoji = 'ğŸ‰';
            } else if (action === 'closed') {
              color = 15158332; // ë¹¨ê°„ìƒ‰
              actionText = 'PR ë‹«í˜';
              emoji = 'âŒ';
            } else {
              return; // ê¸°íƒ€ ì•¡ì…˜ì€ ë¬´ì‹œ
            }
            
            // ì—°ê²°ëœ ì´ìŠˆ ì°¾ê¸°
            const linkedIssues = pr.body?.match(/#(\d+)/g) || [];
            const issueNumbers = linkedIssues.join(', ') || 'ì—†ìŒ';
            
            const embed = {
              title: `${emoji} ${actionText}`,
              description: `**#${pr.number}** ${pr.title}`,
              color: color,
              fields: [
                {
                  name: 'ğŸ‘¤ ì‘ì„±ì',
                  value: actor,
                  inline: true
                },
                {
                  name: 'ğŸ”— ì—°ê²° ì´ìŠˆ',
                  value: issueNumbers,
                  inline: true
                },
                {
                  name: 'ğŸŒ¿ ë¸Œëœì¹˜',
                  value: `${pr.head.ref} â†’ ${pr.base.ref}`,
                  inline: false
                }
              ],
              url: pr.html_url,
              timestamp: new Date().toISOString()
            };
            
            await fetch(webhook_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            
            console.log('âœ… PR notification sent');