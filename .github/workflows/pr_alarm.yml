name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Send PR Alert to Discord
        uses: actions/github-script@v7
        with:
          script: |
            const webhook_url = "${{ secrets.DISCORD_PR_WEBHOOK}}";
            
            const pr = context.payload.pull_request;
            const action = context.payload.action;
            const actor = context.payload.sender.login;
            
            // 액션별 설정
            let color, actionText, emoji;
            if (action === 'opened') {
              color = 3066993; // 초록색
              actionText = '새 PR 생성';
              emoji = '🔀';
            } else if (action === 'closed' && pr.merged) {
              color = 6817668; // 보라색
              actionText = 'PR 머지 완료';
              emoji = '🎉';
            } else if (action === 'closed') {
              color = 15158332; // 빨간색
              actionText = 'PR 닫힘';
              emoji = '❌';
            } else {
              return; // 기타 액션은 무시
            }
            
            // 연결된 이슈 찾기
            const linkedIssues = pr.body?.match(/#(\d+)/g) || [];
            const issueNumbers = linkedIssues.join(', ') || '없음';
            
            const embed = {
              title: `${emoji} ${actionText}`,
              description: `**#${pr.number}** ${pr.title}`,
              color: color,
              fields: [
                {
                  name: '👤 작성자',
                  value: actor,
                  inline: true
                },
                {
                  name: '🔗 연결 이슈',
                  value: issueNumbers,
                  inline: true
                },
                {
                  name: '🌿 브랜치',
                  value: `${pr.head.ref} → ${pr.base.ref}`,
                  inline: false
                }
              ],
              url: pr.html_url,
              timestamp: new Date().toISOString()
            };
            
            await fetch(webhook_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            
            console.log('✅ PR notification sent');